import sys
import os

# ==========================================
# üîß FIX PATH
# ==========================================
current_dir = os.path.dirname(os.path.abspath(__file__)) # ‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ
parent_dir = os.path.dirname(current_dir)              # ‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏õ 1 ‡∏Ç‡∏±‡πâ‡∏ô (‡πÑ‡∏õ‡∏ó‡∏µ‡πà project root)
sys.path.insert(0, parent_dir)                         # ‡πÄ‡∏û‡∏¥‡πà‡∏° path ‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
# ==========================================

# test_integration_real.py
import services
import db_handler
import time

def test_real_flow():
    print("üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£ (Real Integration Test)...")
    
    # ----------------------------------------------------
    # 1. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ (Services <-> Alpha Vantage)
    # ----------------------------------------------------
    print("\n[1/4] ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏∏‡πâ‡∏ô (TSLA)...")
    price = services.get_current_price("TSLA")
    if price > 0:
        print(f"‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏≤‡∏Ñ‡∏≤ TSLA: ${price}")
    else:
        print("‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡πÄ‡∏ä‡πá‡∏Ñ API Key ‡∏´‡∏£‡∏∑‡∏≠ Limit)")
        # ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏•‡∏≠‡∏°‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏™‡∏ï‡πà‡∏≠
        price = 100.0

    # ----------------------------------------------------
    # 2. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö AI (Services <-> Gemini)
    # ----------------------------------------------------
    print("\n[2/4] ‡∏ó‡∏î‡∏™‡∏≠‡∏ö AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö...")
    mock_news = [{"title": "Elon Musk says Tesla will fly tomorrow."}]
    
    # ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á
    analysis = services.analyze_content("NEWS", "TSLA", mock_news)
    
    if analysis and "impact_score" in analysis:
        print(f"‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! AI ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤: Score {analysis['impact_score']}")
        print(f"   Summary: {analysis['summary_message']}")
    else:
        print("‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! AI ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î Format")
        return # ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤ AI ‡∏û‡∏±‡∏á

    # ----------------------------------------------------
    # 3. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Database (DB Handler <-> Supabase)
    # ----------------------------------------------------
    print("\n[3/4] ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Supabase...")
    try:
        # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö
        db_handler.save_prediction(
            symbol="TEST-TICKER",
            source_type="TEST",
            summary="This is a connection test.",
            direction="UP",
            score=9,
            current_price=price
        )
        print("‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏•‡∏≠‡∏á‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö Supabase ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏°‡∏µ TEST-TICKER ‡πÑ‡∏´‡∏°")
    except Exception as e:
        print(f"‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å DB ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: {e}")

    # ----------------------------------------------------
    # 4. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö LINE (Services <-> LINE API)
    # ----------------------------------------------------
    print("\n[4/4] ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á LINE...")
    try:
        services.send_line_push("üß™ ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö Integration Test (‡∏ñ‡πâ‡∏≤‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô)")
        print("‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì")
    except Exception as e:
        print(f"‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! ‡∏™‡πà‡∏á LINE ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: {e}")

if __name__ == "__main__":
    test_real_flow()